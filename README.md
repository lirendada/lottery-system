# ä¼ä¸šçº§æŠ½å¥–ç³»ç»Ÿ

åŸºäº Spring Boot çš„åˆ†å¸ƒå¼æŠ½å¥–è¥é”€å¹³å°ï¼Œæ”¯æŒæ´»åŠ¨ç®¡ç†ã€å¥–å“é…ç½®ã€ç”¨æˆ·æŠ½å¥–ã€ä¸­å¥–é€šçŸ¥ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨å¼‚æ­¥è§£è€¦æ¶æ„ï¼Œå…·å¤‡å®Œå–„çš„å¼‚å¸¸å¤„ç†ä¸æ•°æ®ä¸€è‡´æ€§ä¿éšœæœºåˆ¶ï¼Œèƒ½å¤Ÿåº”å¯¹é«˜å¹¶å‘æŠ½å¥–åœºæ™¯ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æŠ€æœ¯äº®ç‚¹](#æŠ€æœ¯äº®ç‚¹)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [æ¥å£æ–‡æ¡£](#æ¥å£æ–‡æ¡£)
- [å¼€å‘è®¡åˆ’](#å¼€å‘è®¡åˆ’)

---

## ğŸ¯ é¡¹ç›®ç®€ä»‹

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¼ä¸šçº§æŠ½å¥–è¥é”€è§£å†³æ–¹æ¡ˆï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š

- **æ´»åŠ¨ç®¡ç†**ï¼šæ”¯æŒåˆ›å»ºæŠ½å¥–æ´»åŠ¨ã€é…ç½®æ´»åŠ¨å¥–å“ã€ç®¡ç†å‚ä¸ç”¨æˆ·
- **æŠ½å¥–åŠŸèƒ½**ï¼šåŸºäº MQ çš„å¼‚æ­¥æŠ½å¥–å¤„ç†ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯
- **ä¸­å¥–é€šçŸ¥**ï¼šè‡ªåŠ¨é‚®ä»¶é€šçŸ¥ä¸­å¥–ç”¨æˆ·
- **æ•°æ®ä¸€è‡´æ€§**ï¼šå®Œå–„çš„äº‹åŠ¡å›æ»šæœºåˆ¶ï¼Œä¿éšœæ•°æ®å‡†ç¡®æ€§
- **çŠ¶æ€æµè½¬**ï¼šæ´»åŠ¨ã€å¥–å“ã€ç”¨æˆ·çŠ¶æ€çš„è‡ªåŠ¨åŒ–ç®¡ç†

## ğŸ›  æŠ€æœ¯æ ˆ

### åç«¯æ¡†æ¶
- **Spring Boot 3.5.3** - æ ¸å¿ƒæ¡†æ¶
- **MyBatis 3.0.3** - æŒä¹…å±‚æ¡†æ¶
- **MySQL** - å…³ç³»å‹æ•°æ®åº“
- **Redis** - ç¼“å­˜ä¸­é—´ä»¶

### æ¶ˆæ¯é˜Ÿåˆ—
- **RabbitMQ** - å¼‚æ­¥æ¶ˆæ¯å¤„ç†
- **æ­»ä¿¡é˜Ÿåˆ—** - æ¶ˆæ¯é‡è¯•æœºåˆ¶

### å·¥å…·åº“
- **Hutool** - Java å·¥å…·é›†ï¼ˆåŠ å¯†ã€éªŒè¯ç ï¼‰
- **JWT** - ç”¨æˆ·è®¤è¯
- **Lombok** - ä»£ç ç®€åŒ–
- **Spring Mail** - é‚®ä»¶å‘é€

### å…¶ä»–
- **çº¿ç¨‹æ± ** - å¼‚æ­¥ä»»åŠ¡å¤„ç†
- **@Transactional** - äº‹åŠ¡ç®¡ç†

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. ç”¨æˆ·ç®¡ç†
- ç”¨æˆ·æ³¨å†Œï¼ˆæ”¯æŒå¯†ç å’ŒéªŒè¯ç ç™»å½•ï¼‰
- JWT ä»¤ç‰Œè®¤è¯
- æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- ç™»å½•æ‹¦æˆªå™¨

### 2. å¥–å“ç®¡ç†
- å¥–å“åˆ›å»ºä¸é…ç½®
- å¥–å“å›¾ç‰‡ä¸Šä¼ 
- å¥–å“ç­‰çº§ç®¡ç†ï¼ˆä¸€ç­‰å¥–ã€äºŒç­‰å¥–ç­‰ï¼‰
- å¥–å“çŠ¶æ€æµè½¬

### 3. æ´»åŠ¨ç®¡ç†
- æ´»åŠ¨åˆ›å»ºä¸é…ç½®
- æ´»åŠ¨å¥–å“å…³è”
- æ´»åŠ¨ç”¨æˆ·ç®¡ç†
- æ´»åŠ¨è¯¦æƒ…æŸ¥è¯¢ï¼ˆæ”¯æŒ Redis ç¼“å­˜ï¼‰
- åˆ†é¡µæŸ¥è¯¢æ´»åŠ¨åˆ—è¡¨

### 4. æŠ½å¥–åŠŸèƒ½
- åŸºäº RabbitMQ çš„å¼‚æ­¥æŠ½å¥–
- æŠ½å¥–ç»“æœæŒä¹…åŒ–
- ä¸­å¥–è®°å½•æŸ¥è¯¢
- å¤šç»´åº¦ç¼“å­˜ï¼ˆå¥–å“ç»´åº¦ + æ´»åŠ¨ç»´åº¦ï¼‰

### 5. ä¸­å¥–é€šçŸ¥
- å¼‚æ­¥é‚®ä»¶å‘é€
- ä¸­å¥–ä¿¡æ¯ä¸ªæ€§åŒ–æ¨é€
- çº¿ç¨‹æ± å¹¶å‘å¤„ç†

### 6. çŠ¶æ€ç®¡ç†
- æ´»åŠ¨çŠ¶æ€æµè½¬ï¼ˆRUNNING â†’ DONEï¼‰
- å¥–å“çŠ¶æ€æµè½¬ï¼ˆAVAILABLE â†’ DONEï¼‰
- ç”¨æˆ·çŠ¶æ€æµè½¬ï¼ˆAVAILABLE â†’ DONEï¼‰
- è´£ä»»é“¾æ¨¡å¼å®ç°çŠ¶æ€æ‰­è½¬

## ğŸ— ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯/å®¢æˆ·ç«¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Controller å±‚            â”‚
â”‚  - UserController               â”‚
â”‚  - PrizeController              â”‚
â”‚  - ActivityController           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Service å±‚              â”‚
â”‚  - UserService                  â”‚
â”‚  - PrizeService                 â”‚
â”‚  - ActivityService              â”‚
â”‚  - DrawPrizeService             â”‚
â”‚  - ConvertStatusService         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MQ & ç¼“å­˜å±‚              â”‚
â”‚  - RabbitMQ (å¼‚æ­¥å¤„ç†)           â”‚
â”‚  - Redis (ç¼“å­˜)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®æŒä¹…å±‚               â”‚
â”‚  - MyBatis Mapper               â”‚
â”‚  - MySQL æ•°æ®åº“                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæµç¨‹ï¼šæŠ½å¥–å¤„ç†æµç¨‹

```
æŠ½å¥–è¯·æ±‚
   â”‚
   â–¼
å‘é€åˆ° RabbitMQ
   â”‚
   â–¼
MqReceiver æ¶ˆè´¹æ¶ˆæ¯
   â”‚
   â”œâ”€â†’ æ ¡éªŒæ¶ˆæ¯æœ‰æ•ˆæ€§
   â”‚
   â”œâ”€â†’ çŠ¶æ€æ‰­è½¬ï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰
   â”‚   â”œâ”€ PrizeStatusOperator
   â”‚   â”œâ”€ UserStatusOperator
   â”‚   â””â”€ ActivityStatusOperator
   â”‚
   â”œâ”€â†’ ä¿å­˜ä¸­å¥–ç»“æœï¼ˆDB + Redisï¼‰
   â”‚
   â””â”€â†’ å¼‚æ­¥å‘é€é‚®ä»¶é€šçŸ¥
       â”‚
       â””â”€â†’ å¼‚å¸¸å¤„ç†
           â”œâ”€â†’ å›æ»šçŠ¶æ€
           â”œâ”€â†’ åˆ é™¤ä¸­å¥–è®°å½•
           â””â”€â†’ è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
```

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

### 1. å¼‚æ­¥è§£è€¦ - MQ å‰Šå³°å¡«è°·

ä½¿ç”¨ RabbitMQ å®ç°æŠ½å¥–è¯·æ±‚ä¸ä¸šåŠ¡å¤„ç†çš„å¼‚æ­¥è§£è€¦ï¼š

```java
// å‘é€æŠ½å¥–æ¶ˆæ¯åˆ° MQ
rabbitTemplate.convertAndSend(
    DirectRabbitConfig.EXCHANGE_NAME,
    DirectRabbitConfig.ROUTING,
    message
);
```

**ä¼˜åŠ¿**ï¼š
- å‰Šå³°å¡«è°·ï¼Œåº”å¯¹é«˜å¹¶å‘æŠ½å¥–
- è§£è€¦ä¸šåŠ¡é€»è¾‘ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§
- å¼‚æ­¥å¤„ç†ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### 2. äº‹åŠ¡ä¸€è‡´æ€§ - å®Œå–„çš„å›æ»šæœºåˆ¶

å½“ MQ æ¶ˆæ¯å¤„ç†å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å›æ»šç›¸å…³æ•°æ®ï¼š

```java
try {
    // 1. æ‰­è½¬çŠ¶æ€
    convertStatus(drawPrizeRequestDTO);

    // 2. ä¿å­˜ä¸­å¥–ç»“æœ
    saveDrawPrizeResult(drawPrizeRequestDTO);

    // 3. å‘é€é€šçŸ¥
    sendNotification(winnerRecords);

} catch (Exception e) {
    // å›æ»šçŠ¶æ€ + åˆ é™¤ä¸­å¥–è®°å½•
    rollback(drawPrizeRequestDTO);
    throw e; // è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—é‡è¯•
}
```

### 3. è®¾è®¡æ¨¡å¼ - è´£ä»»é“¾ + ç­–ç•¥æ¨¡å¼

é‡‡ç”¨**è´£ä»»é“¾æ¨¡å¼ + ç­–ç•¥æ¨¡å¼**å°è£…çŠ¶æ€æ‰­è½¬é€»è¾‘ï¼š

```java
// æŠ½è±¡çŠ¶æ€ç®—å­
public abstract class AbstractStatusOperator {
    public abstract Integer sequence();              // æ‰§è¡Œé¡ºåº
    public abstract Boolean needConvert(...);        // æ˜¯å¦éœ€è¦è½¬æ¢
    public abstract Boolean convert(...);            // æ‰§è¡Œè½¬æ¢
}

// å…·ä½“å®ç°
- PrizeStatusOperator    (sequence = 1)
- UserStatusOperator     (sequence = 1)
- ActivityStatusOperator (sequence = 2ï¼Œä¾èµ–å¥–å“çŠ¶æ€)
```

**ä¼˜åŠ¿**ï¼š
- çŠ¶æ€è½¬æ¢é¡ºåºå¯æ§
- æ–°å¢çŠ¶æ€ç±»å‹åªéœ€æ–°å¢ç®—å­
- ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæ˜“æ‰©å±•

### 4. æ­»ä¿¡é˜Ÿåˆ— - æ¶ˆæ¯å¯é æ€§ä¿éšœ

å®ç° RabbitMQ æ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶ï¼š

```java
@RabbitListener(queues = DirectRabbitConfig.DLX_QUEUE_NAME)
public class DlxMqReceiver {
    // æ¥æ”¶å¤±è´¥æ¶ˆæ¯ï¼Œé‡æ–°æŠ•é€’åˆ°åŸé˜Ÿåˆ—
    rabbitTemplate.convertAndSend(
        DirectRabbitConfig.EXCHANGE_NAME,
        DirectRabbitConfig.ROUTING,
        msg
    );
}
```

**é…ç½®**ï¼š
- æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š5 æ¬¡
- è¶…è¿‡é‡è¯•æ¬¡æ•°åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
- æ”¯æŒæ‰‹åŠ¨/è‡ªåŠ¨é‡æ–°æŠ•é€’

### 5. å¤šçº§ç¼“å­˜è®¾è®¡

è®¾è®¡**å¥–å“ç»´åº¦**ä¸**æ´»åŠ¨ç»´åº¦**çš„åŒé‡ç¼“å­˜ç­–ç•¥ï¼š

```java
// å¥–å“ç»´åº¦ç¼“å­˜
String key = activityId + "_" + prizeId;
redisUtil.set(Constants.WINNING_RECORDS_PREFIX + key, data, timeout);

// æ´»åŠ¨ç»´åº¦ç¼“å­˜ï¼ˆæ´»åŠ¨ç»“æŸåç¼“å­˜ï¼‰
String key = String.valueOf(activityId);
redisUtil.set(Constants.WINNING_RECORDS_PREFIX + key, data, timeout);
```

**ç¼“å­˜ç­–ç•¥**ï¼š
- Cache-Aside æ¨¡å¼
- æ´»åŠ¨è¯¦æƒ…ç¼“å­˜ï¼ˆå‡å°‘å¤šè¡¨æŸ¥è¯¢ï¼‰
- ä¸­å¥–è®°å½•ç¼“å­˜ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰

### 6. å¼‚æ­¥é€šçŸ¥ - çº¿ç¨‹æ±  + é‚®ä»¶

åŸºäº Spring çº¿ç¨‹æ± å®ç°ä¸­å¥–é‚®ä»¶å¼‚æ­¥å‘é€ï¼š

```java
@Async("asyncServiceExecutor")
public void pushWinningList(List<WinnerRecordEntity> records) {
    records.forEach(record -> {
        mailUtil.sendSampleMail(
            record.getWinnerEmail(),
            "ä¸­å¥–é€šçŸ¥",
            content
        );
    });
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **JDK**: 17+
- **Maven**: 3.6+
- **MySQL**: 8.0+
- **Redis**: 6.0+
- **RabbitMQ**: 3.9+

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone https://github.com/lirendada/lottery-system.git
   cd lottery_system
   ```

2. **ä¿®æ”¹é…ç½®**
   ç¼–è¾‘ `application.properties`ï¼Œé…ç½®æ•°æ®åº“ã€Redisã€RabbitMQ ç­‰ä¿¡æ¯ï¼š
   ```properties
   # æ•°æ®åº“é…ç½®
   spring.datasource.url=jdbc:mysql://localhost:3306/lottery_system
   spring.datasource.username=root
   spring.datasource.password=your_password

   # Redis é…ç½®
   spring.data.redis.host=localhost
   spring.data.redis.port=6379

   # RabbitMQ é…ç½®
   spring.rabbitmq.host=localhost
   spring.rabbitmq.port=5672
   spring.rabbitmq.username=guest
   spring.rabbitmq.password=guest

   # JWT å¯†é’¥
   jwt.secret=your_secret_key

   # é‚®ä»¶é…ç½®
   spring.mail.host=smtp.qq.com
   spring.mail.username=your_email@qq.com
   spring.mail.password=your_email_auth_code
   ```

3. **åˆå§‹åŒ–æ•°æ®åº“**
   ```sql
   CREATE DATABASE lottery_system;
   -- æ‰§è¡Œ SQL è„šæœ¬ï¼ˆå¦‚æœ‰ï¼‰
   ```

4. **å¯åŠ¨é¡¹ç›®**
   ```bash
   mvn clean install
   mvn spring-boot:run
   ```

5. **è®¿é—®æ¥å£**
   ```
   åŸºç¡€ URL: http://localhost:8080
   ```

## ğŸ“ é¡¹ç›®ç»“æ„

```
lottery_system/
â”œâ”€â”€ src/main/java/com/liren/lottery_system/
â”‚   â”œâ”€â”€ common/                      # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ advice/                  # ç»Ÿä¸€å“åº”å°è£…
â”‚   â”‚   â”œâ”€â”€ config/                  # é…ç½®ç±»ï¼ˆRabbitMQã€JWTç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ constant/                # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ enums/                   # æšä¸¾ç±»
â”‚   â”‚   â”œâ”€â”€ exception/               # è‡ªå®šä¹‰å¼‚å¸¸
â”‚   â”‚   â”œâ”€â”€ interceptor/             # æ‹¦æˆªå™¨
â”‚   â”‚   â”œâ”€â”€ mq/                      # MQ æ¶ˆè´¹è€…
â”‚   â”‚   â”œâ”€â”€ pojo/                    # æ•°æ®å¯¹è±¡
â”‚   â”‚   â””â”€â”€ utils/                   # å·¥å…·ç±»
â”‚   â”œâ”€â”€ controller/                  # æ§åˆ¶å±‚
â”‚   â”œâ”€â”€ mapper/                      # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ service/                     # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ operator/                # çŠ¶æ€ç®—å­ï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰
â”‚   â”‚   â””â”€â”€ impl/                    # å®ç°ç±»
â”‚   â””â”€â”€ LotterySystemApplication.java
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ mapper/                      # MyBatis XML
â”‚   â”œâ”€â”€ application.properties       # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ logback-spring.xml           # æ—¥å¿—é…ç½®
â””â”€â”€ pom.xml                          # Maven é…ç½®
```

## ğŸ“š æ¥å£æ–‡æ¡£

### ç”¨æˆ·æ¨¡å—

| æ¥å£ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/user/register` | POST | ç”¨æˆ·æ³¨å†Œ |
| `/user/login/password` | POST | å¯†ç ç™»å½• |
| `/user/login/code` | POST | éªŒè¯ç ç™»å½• |

### å¥–å“æ¨¡å—

| æ¥å£ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/prize/create` | POST | åˆ›å»ºå¥–å“ |
| `/prize/list` | GET | è·å–å¥–å“åˆ—è¡¨ |

### æ´»åŠ¨æ¨¡å—

| æ¥å£ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/activity/create` | POST | åˆ›å»ºæ´»åŠ¨ |
| `/activity/list` | GET | åˆ†é¡µæŸ¥è¯¢æ´»åŠ¨ |
| `/activity/detail` | GET | è·å–æ´»åŠ¨è¯¦æƒ… |

### æŠ½å¥–æ¨¡å—

| æ¥å£ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/draw/prize` | POST | å‘èµ·æŠ½å¥–ï¼ˆå¼‚æ­¥ï¼‰ |
| `/draw/winning-records` | GET | è·å–ä¸­å¥–è®°å½• |

## ğŸ‘¨â€ğŸ’» ä½œè€…

lirendada

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…çš„æ”¯æŒï¼

---

**ğŸ’¬ å¦‚æœè§‰å¾—é¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª Star â­ï¸**
